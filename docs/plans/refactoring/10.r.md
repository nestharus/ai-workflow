Plan 10 – docs/connection-pooling-patterns.md (Connection &
Resource Pooling Patterns)
Intro Proposal:
NOTE TO GENERATOR (DO NOT EMIT IN OUTPUT):

You are generating `docs/connection-pooling-patterns.md`, one document in a FastAPI backend patterns series.

Global goals:
- Capture how long-lived, pooled resources (DB connections, search clients, HTTP clients) are managed.
- Reflect patterns recommended in `fastapi-best-practices.md` / `fastapi-best-practices-2.md` and current best practices for async resource management.
- Describe patterns conceptually and with inline examples, not with references to specific line numbers.

Specific scope for `connection-pooling-patterns.md`:
- Explain why and how to create connection pools at startup and reuse them across requests.
- Document the SurrealDB pool pattern (async connections, queue or pool abstraction, acquire/return with timeouts).
- Document Elasticsearch (or similar) client pooling and configuration (connections per node, timeouts, retries).
- Recommend patterns for outbound HTTP client reuse (e.g. a single shared `httpx.AsyncClient` in lifespan).
- Provide guidance on tuning pool sizes and timeouts and how to monitor for pool exhaustion.
- Mention connection recycling and error-handling strategies (fail-fast on startup, graceful shutdown).

Out of scope:
- Repository APIs that sit on top of these pools (in `repository-patterns.md`).
- General settings modeling (in `settings-patterns.md`).

Start the generated documentation with the connection pooling patterns heading, not this meta note.
Mistakes/Issues:
- Highly specific config values: The plan mentions an “embedding dimension: 768 (line 69)” in SurrealDB
  pool config. This seems application-specific (likely for a vector index). In a general patterns doc, this detail
  might be out of place. Unless this documentation is specifically for this project (which it is), consider
  whether it’s necessary to mention here. If it is (because the setting exists in code), provide a brief
  explanation: e.g. “(This is specific to our use of SurrealDB for vector search – 768 is the vector dimension
  and is configured in settings).” Otherwise, readers might be puzzled why an embedding dimension is in a
  pooling guide.
- Line references vs explanation: Remove the line number references for connection settings and lifecycle.
  For example, instead of “line 287: built-in pooling from elasticsearch library”, just explain: “The Elasticsearch
  client manages a pool of connections internally, defaulting to 25 connections per node. We configure parameters
  like connections_per_node , request_timeout , max_retries via settings.” This tells what needs to
  be known. Similarly, SurrealDB’s implementation using an asyncio.Queue can be described in prose:
  “Our SurrealDB pool is a simple async queue of connections created at startup (5 by default). Each request
  acquires a connection with a timeout and returns it on completion.” That’s much clearer than pointing to code
  lines.
- Lifespan placement: The doc should explicitly tie the pooling to the FastAPI lifespan events. It does
  implicitly by referencing startup/shutdown, but it might explicitly say: “All pools are initialized in the
  application startup event (inside create_app lifespan) and closed in the shutdown event to release resources.”
  This reinforces the pattern of where to do pooling.
  Missing Best Practices:
- HTTP client pooling: A notable omission is pooling for outbound HTTP requests. Modern best practices
  suggest using a single httpx.AsyncClient (or similar) for all outbound calls, created at startup, rather
  than creating new clients per request . If the application calls external APIs, include a section about
  HTTP client reuse. E.g., “HTTP Client Pooling: Similarly, if the service calls external APIs, initialize a single
  httpx.AsyncClient during startup and reuse it for all requests (and close on shutdown). This keeps
  connections alive and improves performance .” This would fill a gap in the patterns, as it’s a common
  resource to pool just like DB connections.
- Monitoring pool health: Sometimes best practices include monitoring connection pools (e.g. logging if
  pool exhaustion happens frequently). You touched on logging timeouts, which is good. Maybe also suggest
  that developers watch for connection errors or use metrics (if available) to tune pool size. This may be
  beyond documentation scope, but one sentence could be: “Track pool usage over time (via logs or metrics)
  to adjust configuration in production.”
- Thread vs async pools: The doc covers async connection pools. If there are any sync resources, note that
  those would use a threadpool (or process pool) approach. For example, if a library isn’t async, one might use
  to_thread.run_sync as noted. The Elasticsearch section actually notes using anyio.to_thread for
  heavy operations. Emphasize that pattern: the repository uses threadpool for blocking calls – that’s
  effectively pooling threads. This is an important pattern (offloading blocking I/O), so ensure it’s highlighted
  as a best practice (it’s mentioned in passing with line refs; make it a clear statement).
- Connection recycling advice: The plan suggests a pool_recycle for long-lived connections. Since
  SurrealDB likely uses persistent WebSocket or TCP connections, if applicable, mention how one might
  recycle those connections if needed (or explicitly say Surreal doesn’t require it if that’s the case). For
  example, “Long-lived connections can sometimes go stale due to network issues; consider periodically
  renewing them (e.g., reconnecting the DB pool every X hours) in long-running services.” This aligns with the
  pool_recycle idea.
- Security: If applicable, mention that connection credentials (DB URLs, etc.) should be kept in settings and
  not logged. This might fit better in the Settings doc, but could be reinforced here when discussing
  connections. E.g., “Never log connection strings or credentials in plaintext when logging pool initialization.”
  It’s a minor point, but relevant to pooling (since on startup you often log “Connecting to DB at X”).