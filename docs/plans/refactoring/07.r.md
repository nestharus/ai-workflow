'Plan 07 – docs/middleware-patterns.md (Middleware Patterns)
Intro Proposal:
NOTE TO GENERATOR (DO NOT EMIT IN OUTPUT):

You are generating `docs/middleware-patterns.md`, one document in a FastAPI backend patterns series.

Global goals:
- Document HTTP middleware patterns and ordering for security, performance, and observability.
- Follow best practices highlighted in `fastapi-best-practices.md` / `fastapi-best-practices-2.md` and current FastAPI/Starlette guidance.
- Use generic examples; don’t depend on concrete source file line numbers.

Specific scope for `middleware-patterns.md`:
- Explain middleware ordering semantics (request vs response order) and why order matters.
- Define recommended middleware stack (e.g. TrustedHost → Security headers → CORS (if used) → GZip → logging/metrics).
- Describe a custom `SecurityHeadersMiddleware` and what headers it applies.
- Cover GZip compression configuration and when to enable it.
- Cover TrustedHost configuration and how it relates to allowed hosts and environments.
- Mention optional middleware for request/response logging, request IDs, metrics, and rate limiting.
- Describe how to configure middleware via Settings and the application factory.
- Describe basic strategies for testing middleware via integration tests.

Out of scope:
- Detailed settings schema (in `settings-patterns.md`).
- Application factory wiring as a whole (in `factory-patterns.md`).

The generated document should start at the middleware patterns heading, not with this note.
Mistakes/Issues:
- No mention of ProxyHeadersMiddleware: Depending on the deployment, forgetting this could be a
  mistake. If the app is behind a proxy or load balancer, you should mention using Starlette’s
  TrustedHostMiddleware (which you did) and potentially ProxyHeadersMiddleware to ensure the app
  respects X-Forwarded-For and X-Forwarded-Proto headers. Currently, the plan doesn’t mention it. If
  not relevant for your environment, it can be skipped; otherwise, it’s a best practice to note in security
  middleware discussions.
- File reference for tests: It says “Reference tests/conftest.py for test app creation.” Instead of this,
  instruct how to test middleware. For example, “In tests, instantiate the app via the factory and use FastAPI’s
  TestClient or AsyncClient to verify middleware. (Our test fixtures already handle this initialization – see
  test guide.)” This way, the middleware doc doesn’t require reading test code, it just points out that
  middleware should be tested in integration.
- Order of CORS middleware: The plan correctly notes to add CORS before others if needed. Perhaps
  clarify: “If using CORS middleware, it should be added at the top (before security and compression) so that it
  can handle preflight OPTIONS requests properly.” This is implied but stating explicitly would prevent misordering.
  Missing Best Practices:
- Rate limiting middleware: One common middleware not mentioned is rate limiting or throttling. If this is
  something you foresee, you might briefly note it under “Custom Middleware or Security” – e.g. “In case of
  needing rate limiting, prefer using Starlette or third-party middleware rather than implementing in business
  logic.” This might be beyond scope, but it’s a thought given comprehensive best practices.
- Performance monitoring middleware: Another optional mention – middleware can be used for APM
  (application performance monitoring) or metrics. For completeness, you could note that adding middleware
  for logging, metrics, request IDs, etc., is possible and encouraged for observability (some of this is touched
  under request/response logging). Ensure “request ID generation” as mentioned is considered (e.g. using an
  ID in logs to trace requests).
- Middleware config in settings: You covered making things configurable (good). One minor addition:
  when making security headers configurable (e.g. enforce_https or allowed hosts), caution that in
  production those should be set to secure values (True or specific domains). Perhaps the
  SecurityHeadersMiddleware should also only be enabled when appropriate (likely always on in prod). Just
  ensure the docs reflect that default settings might allow all (like allowed_hosts=["*"] ) but production
  should tighten it – the plan does imply that.
- Testing advice: The testing section is fine; you could also mention using the TestClient to simulate
  requests that trigger each middleware’s functionality (e.g. sending a request with an unacceptable Host
  header to see TrustedHost work, or a large payload to see GZip response). Encouraging targeted tests for
  middleware behavior is a good practice so that one doesn’t only rely on end-to-end tests to catch
  middleware issues.'