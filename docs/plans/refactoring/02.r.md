Plan 02 – docs/service-patterns.md (Service Layer Patterns)
Intro Proposal:
NOTE TO GENERATOR (DO NOT EMIT IN OUTPUT):

You are generating `docs/service-patterns.md`, one document in a larger FastAPI backend patterns series.

Global goals:
- Capture 2024–2025 best practices for service-layer design in a FastAPI application.
- Separate HTTP concerns from business logic.
- Use `fastapi-best-practices.md` and `fastapi-best-practices-2.md` as authoritative; use `api-patterns-guide.md` only where it agrees with those or with current best practices.
- Use inline, generic examples; do not depend on specific files or line numbers.

Specific scope for `service-patterns.md`:
- Define what a “service” is: responsibilities, boundaries, and how it fits between routers and repositories.
- Emphasize that services are HTTP-agnostic (no FastAPI/Starlette types or HTTP status codes).
- Describe constructor-based dependency injection (repositories, settings, clients) and typical lifetime (usually request-scoped).
- Describe transaction management boundaries: services coordinate units of work, repositories do not commit.
- Describe how services raise domain exceptions (e.g., `DomainError`, `UserNotFoundError`) instead of `HTTPException`.
- Document testing patterns for services (unit tests with mocks, integration tests with real repositories).

Out of scope:
- Router decorators and HTTP-level details (those go into `router-patterns.md` and `exception-patterns.md`).
- Direct data-access details (those go into `repository-patterns.md` and `connection-pooling-patterns.md`).

Begin the emitted document with the heading for the service patterns, not this note.
Mistakes/Issues:
- File references as examples: The plan references ExampleService(prefix="[DEMO]") in
  example.py and line numbers in db_connections.py . These should be replaced with generalized
  examples. For instance, show a pseudo-code snippet of injecting a dependency into a service, or illustrate
  transaction wrapping with a simplified code block, rather than referring to file lines.
- Docstring guide reference: It mentions documenting exceptions in docstrings and references docs/
  docstrings-guide.md . Ensure that guide exists and is up-to-date. If not, either create it or remove the
  reference. The recommendation to use Google style for docstrings is fine, just make sure the
  documentation doesn’t assume a guide that isn’t present.
- Mandatory shutdown() method: The plan insists on a shutdown() in every service. If the codebase
  doesn’t yet have services holding long-lived resources, this might be overkill. It’s a good practice for
  cleanup, but the documentation should clarify when to implement shutdown() (i.e. only if the service
  allocates external connections or threads). Otherwise, developers might create empty shutdown methods
  unnecessarily.
  Missing Best Practices:
- No HTTP in services: This is stated (“services must remain HTTP-agnostic”), which is good. You might add
  that services should not access app.state or global settings directly – they should receive everything
  via constructor or function parameters. (The anti-patterns do mention not using globals in services, which
  covers this).
- Concurrency considerations: It could be worth noting that services, being typically request-scoped, are
  lightweight and created per request. If a service is ever made a singleton or long-lived (which the plan
  advises against except for specific cases), developers must ensure thread-safety. This might be beyond
  scope, but a one-line warning could help (e.g. “Services are not meant to be used as shared singletons
  across threads without proper synchronization”).
- Transaction pattern clarity: The transaction management section is good, but consider illustrating it. For
  example, pseudo-code in a service method: open transaction -> call multiple repository methods -> commit
  or rollback on exception. This will reinforce how the “Unit of Work” boundary looks in practice.
- Overlap with repository doc: Both service and repository docs talk about transaction handling (service
  does commit, repository does not). This overlap is actually helpful for emphasis. Just ensure they use
  consistent terminology and perhaps cross-reference each other (e.g. the repository patterns doc could
  mention “(see Service Layer Patterns for transaction boundaries)” to remind readers where commits
  happen).