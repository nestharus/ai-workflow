Plan 04 – docs/factory-patterns.md (Application Factory &
Lifespan Patterns)
Intro Proposal:
NOTE TO GENERATOR (DO NOT EMIT IN OUTPUT):

You are generating `docs/factory-patterns.md`, one document in a FastAPI backend patterns series.

Global goals:
- Describe how the application is instantiated and wired: factory function, lifespan, middleware, routers, settings, and exception handlers.
- Follow best practices from `fastapi-best-practices.md` / `fastapi-best-practices-2.md`.
- Use inline examples rather than pointing to specific source file line numbers.

Specific scope for `factory-patterns.md`:
- Document the application factory pattern (e.g. `create_app(settings: Settings) -> FastAPI`).
- Explain lifespan management: startup/shutdown, resource initialization, storing resources in `app.state`, and cleanup.
- Describe how to register routers, middleware, and global exception handlers in the factory.
- Describe how settings are injected into the app (e.g. `app.state.settings`) and how they are used by other layers.
- Explain OpenAPI customization performed in the factory (e.g. adding common components, flattening schemas) at a conceptual level.

Out of scope:
- Detailed middleware behavior (in `middleware-patterns.md`).
- Detailed settings modeling and validation (in `settings-patterns.md`).
- Service/repository behavior (in their respective documents).

The generated document should begin with the factory patterns heading, not this note.
Mistakes/Issues:
- Line number references: This doc is heavy with references to specific lines in app/core/factory.py
  and others (for lifespan, router include, OpenAPI tweaks, etc.). All these should be generalized. For example,
  describe the lifespan usage in words or pseudocode rather than “(lines 33-63)”. For OpenAPI customization,
  instead of citing lines 108-111, explain what the customization does (e.g. “flattening Pydantic $defs to
  improve schema readability”). By removing the need to read the source alongside the doc, you make the
  guide self-sufficient.
- Scope of “factory” doc: Ensure this documentation stays focused on application startup/config patterns.
  A couple of sections drift into other areas: e.g., OpenAPI Customization and Settings Integration might
  overlap with the Settings Patterns doc. They are fine to include here (since they happen in factory), but
  double-check for consistency. For instance, if the Settings doc (Plan 08) also mentions storing settings in
  app.state , make sure both docs agree. If both docs talk about it, you might simplify one to avoid
  repetition (maybe the factory doc can briefly mention it and point to Settings doc for details on
  configuration).
- Middleware order note: Section 5 says “Add middleware in correct order (see middleware-patterns.md).”
  That cross-reference is good. Just confirm that the middleware doc covers the ordering sufficiently (Plan 07
  does) so the reader will find details there. Perhaps explicitly state the recommended order here as well
  (TrustedHost → Security → GZip), or at least ensure the two docs don’t contradict. Currently, this plan’s
  example order (TrustedHost → Security → GZip) matches Plan 07, so that’s consistent.
- Example clarity: The Router Registration section references “line 85” for including routers. Instead,
  clarify that the factory should call app.include_router(api_router, prefix="/api/v1") (for
  example). A code snippet like:
  app = FastAPI(...)
  from app.api.v1 import router as api_v1_router
  app.include_router(api_v1_router, prefix=settings.api_prefix)
  would illustrate this well. The same applies to showing how health checks are included with
  include_in_schema=False – just explain it rather than citing a line.
  Missing Best Practices:
- Proxy headers / behind load balancer: One thing often configured at startup is handling proxy headers
  (client IP, protocol) when behind proxies. If this application will be behind a reverse proxy, consider
  mentioning adding ProxyHeadersMiddleware or setting trust_proxy_headers=True on Uvicorn.
  The factory is where this would be done. If it’s relevant to the deployment, it’s a good practice to note.
- App configuration: The doc might mention setting application metadata like title, CORS, etc., but those
  might be considered out of scope or covered elsewhere. If not covered in any plan, a brief note that the
  factory sets up things like app.title , version, and other FastAPI configs (if applicable) could be included.
- Error handlers: It’s great that this covers registering exception handlers. Ensure it aligns with the
  Exception Patterns doc (Plan 06). For example, if Plan 06 introduces a custom DomainError handler, this
  Factory doc should mention registering it. Currently it says “register custom handlers in factory” and gives
  the example of RequestValidationError – you might add “and similarly, register the DomainError
  handler here” once that’s implemented, to tie the two docs together.