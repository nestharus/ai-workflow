I have created the following plan after thorough exploration and analysis of the codebase. Follow the below plan verbatim. Trust the files and references. Do not re-verify what's written in the plan. Explore only when absolutely necessary. First implement all the proposed file changes and then I'll review all the changes together at the end.

### Observations

The current codebase has a solid foundation with modern FastAPI and Pydantic v2 patterns, including lifespan management in `app/core/factory.py`, async connection pooling in `app/infrastructure/db_connections.py`, and proper test fixtures in `tests/conftest.py`. However, there's no centralized documentation of these patterns, and some areas need alignment with 2024-2025 best practices:

**Current Strengths:**
- Pydantic v2 with `ConfigDict(extra="forbid")` in contracts
- Async connection pooling for SurrealDB and Elasticsearch
- Lifespan management with proper startup/shutdown
- ORJSONResponse for performance
- Structured test fixtures with integration and E2E separation

**Gaps Identified:**
- No unified error handling with `AppError`/`DomainError` pattern
- No generic `Paginated[T]` model for consistent pagination
- Dependency injection scattered across files (inline in routers)
- No repository pattern documentation or implementation
- Testing uses monkeypatch instead of `dependency_overrides`
- No middleware stack documentation (security headers, compression)
- Missing comprehensive pattern documentation

**Research Findings:**
From FastAPI docs and 2024 best practices, the following patterns should be documented:
1. Centralized dependency injection with `Annotated` type aliases
2. Unified error handling with custom exception handlers
3. Repository pattern for data access abstraction
4. Middleware ordering (TrustedHost → Security → GZip)
5. Testing with `app.dependency_overrides` instead of monkeypatch
6. Generic Pydantic models for pagination
7. Service layer that raises domain exceptions

### Approach

Create 1 comprehensive Markdown documentation file in `docs/` that establish patterns for the entire FastAPI application architecture. Each file will:

1. Define the pattern with clear rationale
2. Provide code examples from the existing codebase where applicable
3. Include 2024-2025 best practices from FastAPI and Pydantic v2
4. Reference related patterns in other documentation files
5. Include anti-patterns to avoid

The documentation will serve as the single source of truth for development patterns, ensuring consistency across the codebase and enabling future refactoring phases to align with these standards.

### Reasoning

I explored the current codebase structure by reading key files including `app/core/factory.py`, `app/infrastructure/db_connections.py`, `tests/conftest.py`, and various contracts, services, and routers. I then used context7 to resolve FastAPI and Pydantic library documentation, firecrawl to scrape official FastAPI documentation on dependencies, error handling, middleware, and bigger applications, and web search to find 2024 best practices for repository patterns, connection pooling, and testing with dependency_overrides. This comprehensive research provided the foundation for creating detailed pattern documentation.

## Proposed File Change

### docs\middleware-patterns.md(NEW)

References:

- app\core\factory.py
- app\core\settings.py
- tests\conftest.py

Create middleware patterns documentation covering:

**1. Middleware Ordering (Critical)**
- Order matters: middleware executes in registration order for requests, reverse for responses
- Recommended order (first to last):
    1. `TrustedHostMiddleware` (if configured) - validates Host header
    2. `SecurityHeadersMiddleware` (custom, to be created) - adds security headers
    3. `GZipMiddleware` - compresses responses
- Reference FastAPI docs: use `app.add_middleware()` in `app/core/factory.py`

**2. Security Headers Middleware**
- Create `app/core/middleware.py` with `SecurityHeadersMiddleware` class
- Add standard security headers:
    - `X-Content-Type-Options: nosniff`
    - `X-Frame-Options: DENY`
    - `Referrer-Policy: strict-origin-when-cross-origin`
    - `Strict-Transport-Security: max-age=31536000; includeSubDomains` (if HTTPS)
- Make configurable via `app/core/settings.py` (enforce_https, allowed_hosts)

**3. GZip Compression Middleware**
- Use FastAPI's built-in `GZipMiddleware`
- Configure `minimum_size=1024` (don't compress small responses)
- Configure `compresslevel=5` (balance speed vs compression)
- Only compresses when client sends `Accept-Encoding: gzip`
- Reference FastAPI docs for configuration options

**4. Trusted Host Middleware**
- Use FastAPI's `TrustedHostMiddleware` for production
- Configure `allowed_hosts` from settings
- Example: `allowed_hosts=["example.com", "*.example.com"]`
- Returns 400 for invalid Host headers
- Add to settings: `allowed_hosts: list[str] = ["*"]` (default allows all)

**5. CORS Middleware (if needed)**
- Use `CORSMiddleware` for cross-origin requests
- Configure allowed origins, methods, headers
- Add before other middleware (processes OPTIONS requests)
- Only enable in development or for specific origins in production

**6. Custom Middleware Implementation**
- Implement as ASGI middleware class or function
- Class pattern: `__init__(app, **kwargs)` and `async def __call__(scope, receive, send)`
- Function pattern: `async def middleware(request: Request, call_next)`
- Use `app.add_middleware()` for registration

**7. Middleware Configuration via Settings**
- Add middleware settings to `app/core/settings.py`:
    - `enable_gzip: bool = True`
    - `enforce_https: bool = False` (True in production)
    - `allowed_hosts: list[str] = ["*"]`
- Read settings in factory when adding middleware
- Example: `if settings.enable_gzip: app.add_middleware(GZipMiddleware, ...)`

**8. Request/Response Logging Middleware**
- Log request method, path, status code, duration
- Use structured logging for observability
- Be careful with sensitive data (don't log request bodies by default)
- Consider using middleware for request ID generation

**9. Error Handling in Middleware**
- Middleware should not swallow exceptions
- Let FastAPI's exception handlers process errors
- Use try/finally for cleanup, not try/except
- Log middleware-specific errors before re-raising

**10. Testing Middleware**
- Test middleware in integration tests with `TestClient`
- Verify headers are added correctly
- Test compression with large responses
- Test security headers in different environments
- Reference `tests/conftest.py` for test app creation

**11. Anti-Patterns to Avoid**
- Adding middleware in wrong order (breaks functionality)
- Not making middleware configurable (hardcoded values)
- Middleware that modifies request/response bodies without care
- Middleware that performs heavy computation (blocks event loop)
- Not testing middleware behavior